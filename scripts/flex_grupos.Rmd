---
title: "Margaret"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(here)
library(DT)
library(plotly)
library(readxl)
library(shiny)
library(crosstalk)
library(stringi)
```

```{r global}
articulos_unicos_2016_2020 <- 
  read_csv(here("output",
                "articulos.csv")) |> 
  filter(ano >= 2016)

capitulos_2016_2020 <- 
  read_csv(here("output",
                "capitulos.csv")) |> 
  filter(ano >= 2016)

libros_2016_2020 <- 
  read_csv(here("output",
                "libros.csv")) |> 
  filter(Ano >= 2016)

software_2016_2020 <- 
  read_csv(here("output",
                "softwares.csv")) |> 
  filter(ano >= 2016)

trabajo_2016_2020 <- 
  read_csv(here("output",
                "trabajos_dirigidos.csv")) |> 
  mutate(hasta = str_remove(hasta, ".* "),
         hasta = str_trim(hasta),
         desde = str_remove(desde, "\\d.* "),
         desde = str_trim(desde)) |> 
  filter(desde >= 2016)

innovacion_2016_2020 <- 
  read_csv(here("output",
                "innovaciones_gestion.csv")) |> 
  filter(ano >= 2016)

grupos_general <- 
  read_csv(here("output",
                "grupos_general.csv"))

investigadores_general <- 
  read_csv(here("output", 
                "investigadores.csv"))

revistas_actuales <-
  read_csv(here("output", 
                "current_journals.csv"))

```


# General

## Column {.tabset}

### Grupos

```{r}
grupos_general |> 
  select(grupo, clasificacion, sum_papers, departamento , url,
         fecha_creacion,lider, email, area_conocimiento_1) |> 
  mutate(url= str_c("<a href=",
                     url,
                     ">Link</a>")) |> 
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Clasificación", "Cantidad artículos",
                         "Departamento","GrupLAC", 
                         "Fecha Creación", "Líder", "Email", 
                         "Área de Conocimiento"))
```

### Investigadores

```{r}
investigadores_general |> 
  mutate(url = str_c("<a href=","\"",
                     url,
                     "\"",
                     ">Link</a>"),
         scholar = str_c("<a href=","\"",
                         "https://scholar.google.com/citations?user=",
                         id_scholar,
                         "\"",
                         ">Scholar</a>")) |>
  select(-vinculacion) |> 
  rename(Investigador = researcher,
         Horas = horas_dedicacion,
         CvLAC = url,
         Grupo = grupo,
         Inicio = inicio_vinculacion,
         Formacion = posgrade) |> 
  select(Investigador,
         Grupo,
         unidad_academica,
         CENTRO,
         ZONA,
         articulos,
         capitulos,
         libros,
         softwares,
         trabajos_dirigidos,
         innovaciones,
         h_index,
         clasification,
         Formacion,
         Inicio,
         fin_vinculacion,
         CvLAC,
         scholar) |> 
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Investigador", "Grupo","Unidad", "Centro", 
                         "Zona", "Artículos", "Capítulos", 
                         "Libros", "Softwares", "Trabajos Dirigidos", 
                         "Innovaciones", "H index", "Categoría",
                         "Formación","Inicio","Fin vinculación", "CvLAC", "Scholar"))
```


### Países
```{r}
paises <- articulos_unicos_2016_2020 |> 
  count(pais_revista, sort = TRUE)
paises$porcentaje <- round(prop.table(paises$n),3)*100 
paises |> 
  mutate(porcentaje = str_c(porcentaje," %"),
         pais_revista = if_else(is.na(pais_revista), "No registra", pais_revista)) |> 
  datatable(options = list(pageLength = 20), 
            colnames = c('País revista', 'Cantidad', 'Porcentajes')) 
```

<!-- ### Revistas -->
<!-- ```{r} -->
<!-- revistas_actuales |> -->
<!--   mutate(porcentaje = str_c(porcentaje," %")) |>   -->
<!--   datatable(options = list(pageLength = 20),  -->
<!--             colnames = c('Revista', 'ISSN', 'Categoría Publindex', -->
<!--                          'Categoría Scimago','Cantidad', 'Porcentaje')) -->
<!-- ``` -->

# Producción científica

## Column {.tabset}

### Articulos

```{r}
articulos_unicos_2016_2020 |>
  select(-id) |> 
  mutate(DOI = str_extract(DOI, "\\d.*")) |> 
  mutate(DOI =  str_c("<a href=","\"",
                         "https://doi.org/",
                         DOI,
                         "\"",
                         ">Enlace</a>")) |>  
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Categoría", "Tipo producto",
                         "Título", "País revista", "Revista", 
                         "ISSN","Casiflicación Revista", 
                         "Clasificación Scimago", "Año", "Volumen",
                         "Fasc","Páginas", "Enlace artículo", "Autores",
                         "Unidad","Programa", "Centro"))
```

### Capítulos

```{r}
capitulos_2016_2020 |>
  select(-vol, -tipo_producto) |> 
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Categoría",
                         "Título capitulo", "País", "Año", 
                         "Titulo libro","ISBN", "Páginas", "Editorial",
                         "Autores",
                         "Unidad","Programa", "Centro"))
```

### Libros

```{r}
libros_2016_2020 |>
  select(-Tipo_producto) |> 
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Categoría",
                         "Título libro", "País", "Año", 
                         "ISBN","Editorial", "Autores",
                         "Unidad","Programa", "Centro"))
```

### Softwares

```{r}
software_2016_2020 |>
  select(-nombre_proyecto, -tipo_producto) |> 
  mutate(sitio_web= str_c("<a href=",
                     sitio_web,
                     ">Link</a>")) |>
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Categoría",
                         "Título", "País", "Año", 
                         "Disponibilidad","Sitio web", "Nombre comercial", "Institución financiadora", 
                         "Autores",
                         "Unidad","Programa", "Centro"))
```

### Innovaciones

```{r}
innovacion_2016_2020 |> 
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Categoría", "Tipo Producto",
                         "Título", "país", "Año", 
                         "Disponibilidad","Institución financiadora", "Autores",
                         "Unidad","Programa", "Centro"))
```

### Trabajos dirigidos/turorías

```{r}
trabajo_2016_2020 |> 
  datatable(options = list(pageLength = 15),
            escape = FALSE,
            colnames = c("Grupo", "Categoría", "Tipo Producto",
                         "Título", "Desde", "hasta", 
                         "Tipo orientación","Estudiante", "Programa académico","Páginas", 
                         "Valoración","Institución", "Tutor coautor",
                         "Unidad","Programa", "Centro"))
```

# Producción en cifras

Column {data-width=500}
--------------------------------------

### Producción de articulos por Zona
```{r}
data <- articulos_unicos_2016_2020 |> 
  mutate(id = 1:length(articulos_unicos_2016_2020$titulo)) |> 
  select(categoria_revista, ZONA, id) |> 
  separate_rows(ZONA, sep = " ; ") |>
  separate_rows(ZONA, sep = "; ") |> 
  group_by(categoria_revista, id) |> 
  mutate(ranking = if_else(ZONA %in% c("OCCIDENTE",
                                       "SEDE NACIONAL JOSE CELESTINO MUTIS","SUR",
                                       "CENTRO ORIENTE","CARIBE",
                                       "CENTRO BOGOTA Y CUNDINAMARCA","CENTRO SUR",
                                       "AMAZONAS Y ORINOQUIA","CENTRO BOYACA"), 2,
                           if_else(ZONA == "OTRO", 1,0))) |>
  arrange(ranking) |> 
  mutate(ZONA = paste0(ZONA, collapse = ", "),
         ranking = paste0(ranking, collapse = ", ")) |> 
  unique() |> 
  mutate(ZONA = str_remove(ZONA, ".*, "))
  
  data1 <- ungroup(data) |>
    select(categoria_revista, ZONA) |> 
    count(categoria_revista, ZONA, sort = T, name = "cantidad") |> 
  arrange(categoria_revista)
  datatable(data1,options = list(pageLength = 50),
            colnames = c("Categoria revista", "Zona", "Cantidad"))
```
Column {data-width=500}
--------------------------------------

### Producción de articulos por Unidad
```{r}
data <- articulos_unicos_2016_2020 |> 
  mutate(id = 1:length(articulos_unicos_2016_2020$titulo)) |> 
  select(categoria_revista, unidad_academica, id) |> 
  separate_rows(unidad_academica, sep = " ; ") |>
  separate_rows(unidad_academica, sep = "; ") |> 
  group_by(categoria_revista, id) |> 
  mutate(ranking = if_else(unidad_academica %in% c("ESCUELA DE CIENCIAS ADMINISTRATIVAS,CONTABLES, ECONOMICAS Y DE NEGOCIOS",
                                                   "ESCUELA DE CIENCIAS BASICAS, TECNOLOGIA E INGENIERIA",
                                                   "VICERRECTORIA ACADEMICA Y DE INVESTIGACION",
                                                   "ESCUELA DE CIENCIAS AGRICOLAS, PECUARIAS Y DEL MEDIO AMBIENTE",
                                                   "ESCUELA DE CIENCIAS SOCIALES, ARTES Y HUMANIDADES",
                                                   "ESCUELA DE CIENCIAS DE LA EDUCACION",
                                                   "ESCUELA DE CIENCIAS DE LA SALUD",
                                                   "INSTITUTO VIRTUAL DE LENGUAS",
                                                   "ESCUELA DE CIENCIAS JURIDICA Y POLITICAS",
                                                   "VICERRECTORIA DE SERVICIOS A ASPIRANTES, ESTUDIANTES Y EGRESADOS",
                                                   "VICERRECTORIA DE DESARROLLO REGIONAL"), 2,
                           if_else(unidad_academica == "OTRO", 1,0))) |>
  arrange(ranking) |> 
  mutate(unidad_academica = paste0(unidad_academica, collapse = "; "),
         ranking = paste0(ranking, collapse = ", ")) |> 
  unique() |> 
  mutate(unidad_academica = str_remove(unidad_academica, ".*; "))
  
  data1 <- ungroup(data) |>
    select(categoria_revista, unidad_academica) |> 
    count(categoria_revista, unidad_academica, sort = T, name = "cantidad") |> 
  arrange(categoria_revista)
  datatable(data1,options = list(pageLength = 50),
            colnames = c("Categoria revista", "Zona", "Cantidad"))

```


# Grupos e Investigadores en cifras

Column {data-width=300}
--------------------------------------

### Clasificación Grupos de investigación
```{r}
data1 <- grupos_general |> count(clasificacion) |> arrange(desc(clasificacion))
fig1 <- plot_ly(data1, x = ~clasificacion, y = ~n, type = 'bar')
fig1 <- fig1 %>% layout(title = 'Clasificación',
         xaxis = list(title = ""),
         yaxis = list(title = ""))
fig1
```


Column {data-width=300}
-----------------------------------

### Clasificación Investigadores general
```{r}
datos <- investigadores_general |> count(clasification) |> arrange(desc(clasification)) 
p9 <- datos |> 
  plot_ly(labels= ~clasification, values=~n, type = 'pie')
p9 <- p9 %>% layout(title = 'Categorías',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
p9
```

### Categoría revistas
```{r}
dato2 <- articulos_unicos_2016_2020 |> count(categoria_revista) |>
  arrange(desc(categoria_revista)) |> 
  mutate(categoria_revista = ifelse(is.na(categoria_revista),"N/A",categoria_revista))
p10 <- dato2 |> 
  plot_ly(labels= ~categoria_revista, values=~n, type = 'pie')
p10 <- p10 %>% layout(title = 'Categorías',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
p10
```


Column {data-width=300}
-----------------------------------

### Evolución temporal
```{r}
data3 <- articulos_unicos_2016_2020 |> 
  select(categoria_revista, ano, grupo) |> 
  count(ano, sort = FALSE, name = "producciones")
fig3 <- plot_ly(data3, x = ~ano, y = ~producciones, type = 'scatter', mode = 'lines')
fig3 <- fig3 %>% layout(title = "Producción articulos",
         xaxis = list(title = ""),
         yaxis = list(title = ""))

fig3
```

### Formación Investigadores general
```{r}
data <- investigadores_general |> count(posgrade) |> 
  arrange(desc(posgrade)) |> 
  rename(formacion = 1)
p0 <- data |> 
  plot_ly(labels= ~formacion, values=~n, type = 'pie')
p0 <- p0 %>% layout(title = 'Formación',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
p0
```

# Grupos individual en cifras
column {data-width=500}
-----------------------------------
```{r}
data4 <- investigadores_general |> select(grupo , clasification)|> 
  separate_rows(grupo, sep = "; ") |> 
  group_by(grupo, clasification) |> 
  summarise(n = n())

data5 <- investigadores_general |> select(grupo , posgrade) |> 
  separate_rows(grupo, sep = "; ") |>
  group_by(grupo, posgrade) |> 
  summarise(n = n()) |> 
  rename(m = n,
         formacion = posgrade)
libre <- tibble(grupo= c("N/A","N/A","N/A","N/A","N/A"),
                formacion = c("N/A","N/A","N/A","N/A","N/A"),
                m = c(0,0,0,0,0))
  
data <- rbind(data5, libre) |> 
  rename(clasification = 2)

data6 <- merge(data, data4, by = c("grupo", "clasification"), all = TRUE)

datos_compartidos <- crosstalk::SharedData$new(data6)
filter_select("clasification", "Grupo", datos_compartidos, ~grupo)
```

### Categorías investigadores por grupo
```{r}
p0 <- datos_compartidos |> 
  plot_ly(labels= ~clasification, values=~n, type = 'pie')
p0 <- p0 %>% layout(
  xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
  yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
p0
```

### Formación investigadores por grupo
```{r}
p1 <- datos_compartidos |> 
  plot_ly(labels= ~clasification, values=~m, type = 'pie')
p1 <- p1 %>% layout(
  xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
  yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
p1
```

column {data-width=500}
-----------------------------------
```{r}
data7 <- articulos_unicos_2016_2020 |> 
  select(categoria_revista, ano, grupo) |> 
  count(ano, grupo, sort = FALSE, name = "producciones")
datos_anual <- crosstalk::SharedData$new(data7)
filter_select("Produccion", "Produccion anual por Grupo", datos_anual, ~grupo)
```

### producción anual por grupos
```{r}
p1 <- datos_anual |> 
  plot_ly(x = ~ano, y = ~producciones, type = 'bar')
p1 <- p1 %>% layout(title = "Produccion articulos",
         xaxis = list(title = ""),
         yaxis = list(title = ""))
p1
```